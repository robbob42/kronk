<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kronk Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}">
    <style>
        /* --- General Admin Layout --- */
        .admin-header { background-color: var(--container-dark); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent-blue); }
        .admin-header h1 { color: var(--text-light); margin: 0; font-size: 1.5rem; }
        .admin-header a { color: var(--accent-blue); text-decoration: none; }
        .admin-container { padding: 2rem; max-width: 1200px; margin: 0 auto; }
        .section { background-color: var(--container-dark); padding: 1.5rem 2rem; border-radius: 8px; margin-bottom: 2rem; }
        .section h2 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 0.5rem; }
        .forms-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .form-group label { font-weight: bold; color: #ccc; }
        .form-group input, .form-group textarea { width: 100%; padding: 0.75rem; background-color: var(--bg-dark); color: var(--text-light); border: 1px solid #555; border-radius: 4px; box-sizing: border-box; transition: border-color 0.2s; }
        .form-group input:focus, .form-group textarea:focus { border-color: var(--accent-blue); outline: none; }
        .button { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: bold; color: var(--text-light); transition: opacity 0.2s; }
        .button:hover { opacity: 0.85; }
        .button-primary { background-color: var(--accent-blue); }
        .button-danger { background-color: var(--money-red); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background-color: #383838; padding: 0.75rem; text-align: left; }
        .data-table td { padding: 0.75rem; border-top: 1px solid #444; }
        .data-table tbody tr:nth-child(even) { background-color: #303030; }
        
        /* Specific styles for transaction amounts */
        .text-green { color: var(--money-green); }
        .text-red { color: var(--money-red); }
    </style>
</head>
<body>
    <header class="admin-header">
        <h1>Kronk Admin Panel</h1>
        <a href="/">‚Üê Back to Touchscreen UI</a>
    </header>
    <main class="admin-container">
        <section class="section">
            <h2>Add New Items</h2>
            <div class="forms-grid">
                <form id="addProjectForm">
                    <h3>Add Project</h3>
                    <div class="form-group"><label for="projectName">Project Name</label><input type="text" id="projectName" name="name" required></div>
                    <div class="form-group"><label for="projectValue">Value ($)</label><input type="number" id="projectValue" name="value" step="0.01" required></div>
                    <div class="form-group"><label for="projectPriority">Priority</label><input type="number" id="projectPriority" name="priority" value="100"></div>
                    <div class="form-group"><label for="projectDescription">Description</label><textarea id="projectDescription" name="description" rows="3"></textarea></div>
                    <button type="submit" class="button button-primary">Create Project</button>
                </form>
                <form id="addUserForm">
                    <h3>Add User</h3>
                    <div class="form-group"><label for="userName">User Name</label><input type="text" id="userName" name="name" required></div>
                    <div class="form-group"><label for="userEmail">User Email (for remote access)</label><input type="email" id="userEmail" name="email"></div>
                    <button type="submit" class="button button-primary">Create User</button>
                </form>
            </div>
        </section>

        <section class="section">
            <h2>Manage Projects</h2>
            <table class="data-table" id="projectsTable">
                <thead><tr><th>Name</th><th>Value</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody>
                    {% for project in projects %}
                    <tr data-id="{{ project.id }}">
                        <td>{{ project.name }}</td>
                        <td>${{ "%.2f"|format(project.value) }}</td>
                        <td>{{ project.status }}</td>
                        <td>
                            {% if project.status != 'completed' %}
                            <button class="button button-danger" data-id="{{ project.id }}" data-name="{{ project.name }}">Archive</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        <section class="section">
            <h2>Manage Users</h2>
            <table class="data-table" id="usersTable">
                <thead><tr><th>Name</th><th>Email</th><th>Balance</th><th>Actions</th></tr></thead>
                <tbody>
                    {% for user in users %}
                    <tr data-id="{{ user.id }}">
                        <td>{{ user.name }}</td>
                        <td>{{ user.email or 'N/A' }}</td>
                        <td>${{ "%.2f"|format(user.balance) }}</td>
                        <td><button class="button button-danger" data-id="{{ user.id }}" data-name="{{ user.name }}">Archive</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        <section class="section">
            <h2>Transaction Log</h2>
            <table class="data-table" id="transactionsTable">
                <thead><tr><th>Date</th><th>User</th><th>Amount</th><th>Actions</th></tr></thead>
                <tbody>
                    {% for t in transactions %}
                    <tr data-id="{{ t.id }}">
                        <td>{{ t.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ t.user.name }}</td>
                        <td>
                            <span class="{{ 'text-green' if t.amount > 0 else 'text-red' }}">
                                ${{ "%.2f"|format(t.amount) }}
                            </span>
                        </td>
                        <td>
                            {% if t.amount < 0 %}
                            <button class="button button-danger delete-transaction-btn" data-id="{{ t.id }}" data-amount="{{ t.amount }}">Delete</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
    </main>

    <script>
        document.getElementById('addProjectForm').addEventListener('submit', async (e) => { e.preventDefault(); const form = e.target; const data = Object.fromEntries(new FormData(form).entries()); data.value = parseFloat(data.value); data.priority = parseInt(data.priority); const response = await fetch('/api/projects', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); if (response.ok) { alert('Project created!'); window.location.reload(); } else { alert('Error creating project.'); } });
        document.getElementById('addUserForm').addEventListener('submit', async (e) => { e.preventDefault(); const form = e.target; const data = Object.fromEntries(new FormData(form).entries()); const response = await fetch('/api/users', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); if (response.ok) { alert('User created!'); window.location.reload(); } else { alert('Error creating user.'); } });
        const setupArchiveListeners = (tableId, apiEndpoint) => { document.getElementById(tableId).addEventListener('click', async (e) => { const button = e.target.closest('.button-danger'); if (!button) return; const id = button.dataset.id; const name = button.dataset.name; if (confirm(`Are you sure you want to archive "${name}"? It will be hidden from view.`)) { const response = await fetch(`/api/${apiEndpoint}/${id}/archive`, { method: 'POST' }); if (response.ok) { document.querySelector(`tr[data-id='${id}']`).remove(); } else { const result = await response.json(); alert(`Error: ${result.error}`); } } }); };
        setupArchiveListeners('projectsTable', 'projects');
        setupArchiveListeners('usersTable', 'users');

        document.getElementById('transactionsTable').addEventListener('click', async (e) => {
            if (!e.target.classList.contains('delete-transaction-btn')) return;
            
            const button = e.target;
            const id = button.dataset.id;
            const amount = button.dataset.amount;
            
            if (confirm(`Are you sure you want to delete this transaction for ${amount}? This will refund the money to the user.`)) {
                const response = await fetch(`/api/transactions/${id}`, { method: 'DELETE' });
                
                if (response.ok) {
                    alert('Transaction deleted.');
                    window.location.reload(); // Reload to reflect the new balance
                } else {
                    alert('Error deleting transaction.');
                }
            }
        });
    </script>
</body>
</html>